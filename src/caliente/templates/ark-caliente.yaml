{{- $namespace := $.Release.Namespace -}}
{{- $app := $.Release.Name -}}
{{- $objectName := (include "arkcase.caliente.objectName" $) -}}
{{- $acmeInfo := (include "arkcase.caliente.acme" $ | fromYaml) -}}
{{- $dataVol := "data" -}}
{{- $tempVol := "temp" -}}
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: &objectName {{ $objectName | quote }}
  labels: &labels
    app: &app {{ $app | quote }}
    app.kubernetes.io/instance: *app
    app.kubernetes.io/name: *objectName
spec:
  replicas: 1
  selector:
    matchLabels:
      <<: *labels
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      annotations:
        prometheus.io/port: "9100"
        prometheus.io/scrape: "true"
      labels:
        <<: *labels
      name: *objectName
    spec:
      {{- include "arkcase.image.pullSecrets" $ | nindent 6 }}
      {{- with $.Values.hostAliases }}
      hostAliases: {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if $.Values.schedulerName }}
      schedulerName: {{ $.Values.schedulerName | quote }}
      {{- end }}
      serviceAccountName: {{ include "arkcase.serviceAccountName" $ | quote }}
      securityContext: {{- include "arkcase.securityContext" $ | nindent 8 }}
      terminationGracePeriodSeconds: 15
      initContainers:
        - name: init-set-permissions
          {{- include "arkcase.image" (dict "ctx" $ "name" "setperm" "repository" "arkcase/setperm") | nindent 10 }}
          env: {{- include "arkcase.tools.baseEnv" $ | nindent 12 }}
            - name: CALIENTE_DIR
              value: &dataDir "/caliente"
            - name: TEMP_DIR
              value: &tempDir "$(CALIENTE_DIR)/temp"
            - name: JOBS
              value: |-
                jobs:
                  # We know the image uses user 26
                  - ownership: "0:0"
                    permissions: "u=rwX,g=rX,o="
                    flags: [ "recurse", "noforced", "create", "changes" ]
                    targets: [ "$(CALIENTE_DIR)", "$(TEMP_DIR)" ]
          volumeMounts:
            - name: &dataVol {{ $dataVol | quote }}
              mountPath: *dataDir
        - name: init-dependencies
          {{- include "arkcase.image" (dict "ctx" $ "name" "nettest" "repository" "arkcase/nettest") | nindent 10 }}
          command: [ "/usr/local/bin/wait-for-ports" ]
          env: {{- include "arkcase.tools.baseEnv" $ | nindent 12 }}
            {{- $acmeInfo.env | toYaml | nindent 12 }}
            - name: CALIENTE_DB_HOST
              valueFrom: &calienteDbHost
                secretKeyRef:
                  name: &db {{ printf "%s-db" $app | quote }}
                  key: endpoint
                  optional: false
            - name: CALIENTE_DB_PORT
              valueFrom: &calienteDbPort
                secretKeyRef:
                  name: *db
                  key: port
                  optional: false
            - name: CALIENTE_S3_ENDPOINT
              valueFrom: &calienteS3Endpoint
                secretKeyRef:
                  name: &s3 {{ printf "%s-content" $app | quote }}
                  key: endpoint
                  optional: false
            - name: INIT_DEPENDENCIES
              value: |-
                dependencies:
                  acme:
                    url: '@env:ACME_URL'
                  db:
                    host: '@env:CALIENTE_DB_HOST'
                    port: '@env:CALIENTE_DB_PORT'
                  s3:
                    url: '@env:CALIENTE_S3_ENDPOINT'
                enabled: true
                mode: all
                template:
                  attempts: 60
                  delay: 10
                  initialDelay: 10
                  mode: any
                  timeout: 10
      containers:
        - name: caliente
          {{- include "arkcase.image" (dict "ctx" $ "name" "caliente" "repository" "arkcase/caliente") | nindent 10 }}
          env: {{- include "arkcase.tools.baseEnv" $ | nindent 12 }}
            {{- $acmeInfo.env | toYaml | nindent 12 }}
            - name: CALIENTE_DIR
              value: *dataDir
            - name: TEMP
              value: *tempDir
            - name: CALIENTE_DB_HOST
              valueFrom:
                <<: *calienteDbHost
            - name: CALIENTE_DB_PORT
              valueFrom:
                <<: *calienteDbPort
            - name: CALIENTE_DB_DATABASE
              valueFrom:
                secretKeyRef:
                  key: database
                  name: *db
                  optional: false
            - name: CALIENTE_DB_SCHEMA
              valueFrom:
                secretKeyRef:
                  key: schema
                  name: *db
                  optional: false
            - name: CALIENTE_DB_USERNAME
              valueFrom:
                secretKeyRef:
                  key: username
                  name: *db
                  optional: false
            - name: CALIENTE_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: *db
                  optional: false
            - name: CALIENTE_S3_ENDPOINT
              valueFrom:
                <<: *calienteS3Endpoint
            - name: CALIENTE_S3_REGION
              valueFrom:
                secretKeyRef:
                  key: region
                  name: *s3
                  optional: false
            - name: CALIENTE_S3_BUCKET
              valueFrom:
                secretKeyRef:
                  key: bucket
                  name: *s3
                  optional: false
            - name: CALIENTE_S3_USERNAME
              valueFrom:
                secretKeyRef:
                  key: username
                  name: *s3
                  optional: false
            - name: CALIENTE_S3_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: *s3
                  optional: false
          volumeMounts:
            - name: arkcase-ssl-trusts
              mountPath: /.trusts
              readOnly: true
            - name: *dataVol
              mountPath: *dataDir
            - name: {{ $tempVol | quote }}
              mountPath: *tempDir
      volumes:
        {{- include "arkcase.file-resource.volumes" $ | nindent 8 }}
        {{- include "arkcase.persistence.ephemeralVolume" (dict "ctx" $ "name" $tempVol) | nindent 8 }}
        - name: arkcase-ssl-trusts
          secret:
            secretName: arkcase-ssl-trusts
            defaultMode: 0444
            optional: true
  volumeClaimTemplates:
    {{- include "arkcase.persistence.volumeClaimTemplate" (dict "ctx" $ "name" $dataVol) | nindent 4 }}

{{- include "arkcase.persistence.declareResources" (dict "ctx" $ "volume" $dataVol) | nindent 0 }}
