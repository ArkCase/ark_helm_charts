{{- if (include "arkcase.subsystem.enabled" $) -}}
  {{- $ctx := $ -}}
  {{- $dbinfo := (include "arkcase.db.info" $ctx | fromYaml) -}}
  {{- $port := $dbinfo.port -}}

  {{- range $conn := (list "arkcase" "alfresco" "pentaho" "pentaho-jcr" "pentaho-quartz") }}
    {{- $username := ($conn | b64enc) }}
    {{- $password := "" }}
    {{- $name := (include "arkcase.subsystem-access.name" (dict "ctx" $ctx "conn" $conn)) }}

    {{- if $.Release.IsUpgrade }}
      {{- $secretData := (include "arkcase.get-existing.config" (dict "ctx" $ "name" $name)) }}
      {{- if and $secretData $secretData.data }}
        {{- $username = (hasKey $secretData.data "username" | ternary $secretData.data.username $username) }}
        {{- $password = (hasKey $secretData.data "password" | ternary $secretData.data.password $password) }}
      {{- end }}
    {{- end }}

    {{- if not $password }}
      {{- $password = (randAlphaNum 64 | b64enc) }}
    {{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $name | quote }}
  namespace: {{ $.Release.Namespace | quote }}
  labels: {{- include "arkcase.labels" $ | nindent 4 }}
    {{- with ($.Values.labels).common }}
      {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    {{- with ($.Values.annotations).common }}
      {{- toYaml . | nindent 4 }}
    {{- end }}
type: Opaque
data:
  endpoint: {{ $dbinfo.hostname | b64enc }}
  port: {{ $port | int | toString | b64enc }}
  username: {{ $username }}
  password: {{ $password }}
  {{- end }}
{{- end -}}
