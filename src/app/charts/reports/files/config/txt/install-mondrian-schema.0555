#!/bin/bash
set -euo pipefail
. /.functions

usage()
{
	echo -e "usage: ${BASH_SOURCE:-${0}} schema.xml [dataSource]"
	exit 1
}

[ ${#} -ge 1 ] || usage
[ ${#} -le 2 ] || usage

SCHEMA_FILE="${1}"
require_file_readable "${SCHEMA_FILE}"
case "${SCHEMA_FILE,,}" in
	*.xml ) ;;
	* ) fail "The schema file must have an extension of .xml (case-insensitive)" ;;
esac
SCHEMA_FILE="$(readlink -f "${SCHEMA_FILE}")"

DATA_SOURCE=""
[ ${#} -eq 2 ] && DATA_SOURCE="${2}"
[ -n "${DATA_SOURCE}" ] || DATA_SOURCE="ArkCase"

xmllint --noout "${SCHEMA_FILE}" &>/dev/null || fail "The schema file at [${SCHEMA_FILE}] is not valid XML, can't install"

NAME="$(xmlstarlet sel -t -v "/Schema/@name" "${SCHEMA_FILE}")" || fail "Failed to parse the name out of the schema at [${SCHEMA_FILE}]"
[ -n "${NAME}" ] || fail "The Mondrian schema at [${SCHEMA_FILE}] lacks a name, can't install"
ENCODED="$(urlencode "${NAME}")"

set_or_default ADMIN_USERNAME "admin"
set_or_default ADMIN_PASSWORD "password"
set_or_default PENTAHO_URL "https://localhost:8443/pentaho"

say "Installing the Mondrian schema [${NAME}] from [${SCHEMA_FILE}]..."
execute curl -fsSL \
	-H "Content-Type: multipart/form-data" \
	-X PUT \
	-F uploadInput="@${SCHEMA_FILE}" \
	-F overwrite="true" \
	-F xmlaEnabledFlag="false" \
	-F parameters="Datasource=${DATA_SOURCE}" \
	--config <(echo -n "--user \"${ADMIN_USERNAME}:${ADMIN_PASSWORD}\"") \
	"${PENTAHO_URL}/plugin/data-access/api/datasource/analysis/catalog/${ENCODED}"
