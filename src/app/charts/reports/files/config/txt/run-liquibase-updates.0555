#!/bin/bash
set -euo pipefail
. /.functions

set_or_default BASE_DIR "/app"
set_or_default LB_DIR "${BASE_DIR}/lb"
set_or_default LOGS_DIR "${BASE_DIR}/logs"
set_or_default CHANGELOG_DIR "${LB_DIR}/pentaho"

cd "${LB_DIR}"

redirect_logs "${LOGS_DIR}/liquibase.stdout.log"

set_as_boolean ARKCASE_ENTERPRISE

CHANGELOGS=("create_quartz:quartz")
"${ARKCASE_ENTERPRISE}" && CHANGELOGS+=("pentaho_mart:hibernate:true")

# We do it like this so we don't enter it multiple times

for CHANGELOG in "${CHANGELOGS[@]}" ; do
	IFS=":" read CHANGELOG DB OPTIONAL <<< "${CHANGELOG}"

	CHANGELOG_FILE="changelog.${CHANGELOG}.xml"
	if is_file_readable "${CHANGELOG_DIR}/${CHANGELOG_FILE}" ; then
		running "Running changelog ${CHANGELOG} ..."
		URL="REPORTS_JDBC_${DB^^}_URL"
		USERNAME="REPORTS_JDBC_${DB^^}_USERNAME"
		PASSWORD="REPORTS_JDBC_${DB^^}_PASSWORD"
		DRIVER="REPORTS_JDBC_${DB^^}_DRIVER"

		export LIQUIBASE_COMMAND_DRIVER="${!DRIVER}"
		[ -n "${LIQUIBASE_COMMAND_DRIVER}" ] || fail "No JDBC driver given for database ${DB}, cannot continue"

		./liquibase update \
			--changelog-file="${CHANGELOG_FILE}" \
			--url="${!URL}" \
			--username="${!USERNAME}" \
			--password="${!PASSWORD}"
		continue
	fi

	as_boolean "${OPTIONAL}" && \
		warn "Skipping the missing optional changelog file [${CHANGELOG_FILE}]" || \
		fail "The required changelog file [${CHANGELOG_FILE}] does not exist!"
done
ok "Changelogs complete."
