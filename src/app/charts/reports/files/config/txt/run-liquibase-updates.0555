#!/bin/bash
set -euo pipefail
. /.functions

set_or_default BASE_DIR "/app"
set_or_default LB_DIR "${BASE_DIR}/lb"
set_or_default LOGS_DIR "${BASE_DIR}/logs"

cd "${LB_DIR}"

redirect_logs "${LOGS_DIR}/liquibase.stdout.log"

set_as_boolean ARKCASE_ENTERPRISE

CHANGELOGS=("create_quartz:quartz")
"${ARKCASE_ENTERPRISE}" && CHANGELOGS+=("pentaho_mart:hibernate")

# We do it like this so we don't enter it multiple times

for CHANGELOG in "${CHANGELOGS[@]}" ; do
	IFS=":" read CHANGELOG DB <<< "${CHANGELOG}"
	running "Running changelog ${CHANGELOG} ..."
	URL="REPORTS_JDBC_${DB^^}_URL"
	USERNAME="REPORTS_JDBC_${DB^^}_USERNAME"
	PASSWORD="REPORTS_JDBC_${DB^^}_PASSWORD"
	DRIVER="REPORTS_JDBC_${DB^^}_DRIVER"

	export LIQUIBASE_COMMAND_DRIVER="${!DRIVER}"
	[ -n "${LIQUIBASE_COMMAND_DRIVER}" ] || fail "No JDBC driver given for database ${DB}, cannot continue"

	./liquibase update \
		--changelog-file="changelog.${CHANGELOG}.xml" \
		--url="${!URL}" \
		--username="${!USERNAME}" \
		--password="${!PASSWORD}"
done
ok "Changelogs complete."
