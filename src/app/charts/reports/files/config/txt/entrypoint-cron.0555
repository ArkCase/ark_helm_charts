#!/bin/bash
set -euo pipefail
. /.functions

###################################################################
# CONFIGURE FILESYSTEM PERSISTENCE                                #
###################################################################
set_or_default BASE_DIR "/app"
set_or_default DATA_DIR "${BASE_DIR}/data"
set_or_default INIT_DIR "${BASE_DIR}/init"

ensure_dir "${DATA_DIR}"
export DATA_DIR

###################################################################
# UPDATE CA CERTIFICATES                                          #
###################################################################
init_ssl

###################################################################
# SET THE JAVA VERSION                                            #
###################################################################
set-java

###################################################################
# Render the correct server.properties file                       #
###################################################################
set_or_default PENTAHO_HOME "${BASE_DIR}/pentaho"
set_or_default PENTAHO_PDI_HOME "${BASE_DIR}/pentaho"
set_or_default PENTAHO_PDI_PLUGINS "${PENTAHO_PDI_HOME}/data-integration/plugins"
set_or_default PENTAHO_SERVER "${PENTAHO_HOME}/pentaho-server"

require_dir_readable "${PENTAHO_SERVER}"

###################################################################
# DEPLOY, AS NEEDED, THE CRON SCHEDULES THAT WE'LL BE RUNNING     #
###################################################################
deploy-job-schedules

###################################################################
# ARKCASE MUST BE UP BEFORE WE START RUNNING JOBS                 #
###################################################################
set_or_default INIT_POLL_SLEEP
[[ "${INIT_POLL_SLEEP}" =~ ^[1-9][0-9]*$ ]] || INIT_POLL_SLEEP=2

set_or_default INIT_MAX_WAIT
[[ "${INIT_MAX_WAIT}" =~ ^[1-9][0-9]*$ ]] || INIT_MAX_WAIT=900

set_or_default CORE_URL "https://core:8443/arkcase/"

doing "Waiting for ArkCase to become available before starting the Cron process..."
poll_url "${CORE_URL}" "${INIT_MAX_WAIT}" "${INIT_POLL_SLEEP}" || fail "ArkCase did not come up in time"

eyes "Storing the runtime environment to a temporary file"
declare -px > "${HOME}/.cron-env"

doing "Starting the Cron process..."

# This is for the new Ubuntu-centric containers
CMD=(/usr/sbin/cron -f -L 15)

# This is vestigial to support Rocky-centric containers
is_file_executable /usr/sbin/crond && CMD=(/usr/sbin/crond -n -P)

# Launch the correct daemon!
execute "${CMD[@]}"
