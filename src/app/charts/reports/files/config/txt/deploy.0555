#!/bin/bash
set -euo pipefail
. /.functions

set_or_default BASE_DIR "/app"
set_or_default INIT_DIR "${BASE_DIR}/init"
set_or_default REPS_DIR "${INIT_DIR}/reports"
set_or_default DATA_DIR "${BASE_DIR}/data"
set_or_default DWHS_DIR "${DATA_DIR}/dw"

export DEPLOY_UPDATE_MARK="true"

#
# Deploy all reports
#
REPORT="$(list-artifacts /pentaho/reports)" || fail "Failed to list the reports for deployment"
readarray -t REPORT < <(echo -n "${REPORT}")
doing "Deploying ${#REPORT[@]} reports for automated installation: [${REPORT[@]}]"
mkdir -p "${REPS_DIR}"
for report in "${REPORT[@]}" ; do
	deploy-artifact copy "${report}" "${REPS_DIR}"
done

#
# Extract all the Data Warehousing stuff
#
DWHS="$(list-artifacts /pentaho/analytical)" || fail "Failed to list the analytical transformations for deployment"
readarray -t DWHS < <(echo -n "${DWHS}")
doing "Deploying ${#DWHS[@]} Analytical Transformations: [${DWHS[@]}]"
mkdir -p "${DWHS_DIR}"
for dwhs in "${DWHS[@]}" ; do
	deploy-artifact extract-dir "${dwhs}" "${DWHS_DIR}"
done

ok "Artifact deployment complete"
exit 0
