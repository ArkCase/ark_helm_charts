#!/bin/bash
set -euo pipefail
. /.functions

DEFAULT_MODE="kettle"

encrypt()
{
	local MODE="${1}"
	local VALUE="${2}"
	"${EXE}" "-${MODE}" "${VALUE}"
}

usage()
{
	echo -e "usage: ${BASH_ARGV0:-${BASH_SOURCE:-${0}}} [kettle|carte]"
	exit 1
}

if [ ${#} -eq 0 ] ; then
	MODE="${DEFAULT_MODE}"
elif [ ${#} -eq 1 ] ; then
	MODE="${1}"
else
	usage
fi
MODE="${MODE,,}"

case "${MODE}" in
	kettle | carte ) ;;
	* ) err "Unsupported encryption mode [${MODE}]" ; usage ;;
esac

[ -v ENCR_SH ] || ENCR_SH=""
[ -n "${ENCR_SH}" ] || ENCR_SH="encr.sh"
require_exe "${ENCR_SH}"

while IFS="=" read -r -d '' NAME REST ; do
	[[ "${NAME}" =~ _PASSWORD$ ]] || continue
	ENC="$(encrypt "${MODE}" "${!NAME}" 2>/dev/null)" || fail "Failed to encrypt the passwords properly"
	echo "export ${NAME}=${ENC@Q};"
done < <(env -0)
