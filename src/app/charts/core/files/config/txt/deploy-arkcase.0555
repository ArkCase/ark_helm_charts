#!/bin/bash
set -euo pipefail
. /.functions

set_or_default COMPONENT "arkcase"
set_or_default BASE_DIR "/app"
set_or_default DEPL_DIR "${BASE_DIR}/depl"
set_or_default WARS_DIR "${DEPL_DIR}/wars"

#
# Deploy all WAR files
#
WAR="$(list-artifacts "/${COMPONENT}/wars")" || fail "Failed to list the WAR files to be deployed"

readarray -t WAR < <(echo -n "${WAR}")

say "Found ${#WAR[@]} WAR files to deploy: [${WAR[@]}]"
for war in "${WAR[@]}" ; do

	ARTIFACT_NAME="${war##*/}"
	BASENAME="${ARTIFACT_NAME%.*}"

	# The default WAR's target is its basename without the extension
	# inside of WARS_DIR
	WAR_TGT="${BASENAME}"

	# Pre-pend the actual target's parent directory
	WAR_TGT="${WARS_DIR}/${WAR_TGT}"

	mkdir -p "${WAR_TGT}" || fail "Failed to create the extraction target at [${WAR_TGT}]"

	# There's no development version, and the WAR is not excluded,
	# so let's go ahead and deploy it normally
	deploy-artifact extract "${war}" "${WAR_TGT}" || fail "Failed to deploy the WAR from [${war}] into [${WAR_TGT}]"
done

#
# Save the SHA-256 of the global artifacts
#
GLOBAL_SUMS="$(get-global-sums)" || fail "Failed to get the artifact global sums"
SUMS_FILE="${WARS_DIR}/.artifacts.global.sums"
echo -n "${GLOBAL_SUMS}" > "${SUMS_FILE}" || fail "Failed to store the artifact global sums into [${SUMS_FILE}]"

ok "Configuration Initialization Complete"
exit 0
