#!/bin/bash

set -euo pipefail
. /.functions

#
# If we're in developer and debugging is enabled, we
# completely disregard the liveness probe and just
# return a 0 exit status
#
as_boolean "${DEVELOPMENT:-false}" && as_boolean "${DEBUG:-false}" && quit "DEBUG mode enabled, this health check is disabled"

#
# Ping Tomcat's internal communications port, which is only opened once
# Tomcat successfully completes its bootup sequence
#
MSG=""
[ ${#} -lt 1 ] || MSG="${@}"
[ -n "${MSG}" ] || MSG="PING"
( timeout --signal=KILL 5 echo -n "PROBE: ${MSG}" > "/dev/tcp/localhost/8005" ) &>/dev/null || fail "Tomcat is not started (${?})"

#
# All is well... ready to go!
#
ok "Tomcat is live!"
