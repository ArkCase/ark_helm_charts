{{- if and (include "arkcase.subsystem.enabled" $) (not (include "arkcase.subsystem.external" $)) -}}
  {{- $ctx := $ -}}

  {{- /* Always use the same service name in the URL */ -}}
  {{- $serviceName := (include "arkcase.service.name" $) -}}

  {{- /* The key is the username, and the value is the comma-separated list of roles to assign */ -}}
  {{- $usersAndRoles := (include "arkcase.artemis.users" $ | fromYaml) -}}
  {{- range $user, $roles := $usersAndRoles }}
    {{- $password := "" }}
    {{- $secretName := (include "arkcase.subsystem-access.name.cred" (dict "ctx" $ctx "type" $user)) }}

    {{- $secretObj := (lookup "v1" "Secret" $ctx.Release.Namespace $secretName) }}
    {{- if $secretObj }}
      {{- $secretData := (get $secretObj "data") }}
      {{- if $secretData }}
        {{- $user = (hasKey $secretData "username" | ternary ($secretData.username | b64dec) $user) }}
        {{- $password = (hasKey $secretData "password" | ternary ($secretData.password | b64dec) "") }}
        {{- $roles = (hasKey $secretData "roles" | ternary ($secretData.roles | b64dec) $roles) }}
      {{- end }}
    {{- end }}

    {{- if not $password }}
      {{- $password = (randAlphaNum 64) }}
    {{- end }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName | quote }}
  namespace: {{ $ctx.Release.Namespace | quote }}
  labels: {{- include "arkcase.labels" $ | nindent 4 }}
    {{- with ($ctx.Values.labels).common }}
      {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    {{- with ($ctx.Values.annotations).common }}
      {{- toYaml . | nindent 4 }}
    {{- end }}
type: Opaque
stringData:
  proto: "ssl"
  host: {{ $serviceName | quote }}
  amq: "61616"
  stomp: "61613"
  username: {{ $user | quote }}
  password: {{ $password | quote }}
  roles: {{ $roles | quote }}
  {{- end }}
{{- end -}}
