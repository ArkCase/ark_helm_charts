{{- if and (include "arkcase.subsystem.enabled" $) (not (include "arkcase.subsystem.external" $)) -}}
  {{- $ctx := $ -}}

  {{- /* Always use the same service name in the URL */ -}}
  {{- $serviceName := (include "arkcase.service.name" $) -}}

  {{- /* The key is the username, and the value is the comma-separated list of roles to assign */ -}}
  {{- $usersAndRoles := (include "arkcase.artemis.users" $ | fromYaml) -}}
  {{- range $username, $settings := $usersAndRoles }}
    {{- $roles := ($settings.roles | default "") }}
    {{- $persistent := (not (empty (include "arkcase.toBoolean" $settings.persistent))) }}

    {{- $password := "" }}
    {{- $secretName := (include "arkcase.subsystem-access.name" (dict "ctx" $ "conn" $username)) }}

    {{- $secretData := (include "arkcase.get-existing.secret" (dict "ctx" $ "name" $secretName) | fromYaml) }}
    {{- if and $secretData $secretData.data }}
      {{- $username = (hasKey $secretData "username" | ternary ($secretData.username) $username) }}
      {{- $password = (hasKey $secretData "password" | ternary ($secretData.password) "") }}
      {{- $roles = (hasKey $secretData "roles" | ternary ($secretData.roles) $roles) }}
    {{- end }}

    {{- if not $password }}
      {{- $password = (randAlphaNum 64) }}
    {{- end }}

    {{-
      $data := dict
        "amqpUrl" (printf "ssl://%s:61616" $serviceName)
        "stompUrl" (printf "ssl://%s:61613" $serviceName)
        "username" $username
        "password" $password
        "roles" $roles
    }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName | quote }}
  namespace: {{ $ctx.Release.Namespace | quote }}
  labels: {{- include "arkcase.labels" $ | nindent 4 }}
    {{- with ($ctx.Values.labels).common }}
      {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    {{- if $persistent }}
    helm.sh/resource-policy: keep
    {{- end }}
    {{- with ($ctx.Values.annotations).common }}
      {{- toYaml . | nindent 4 }}
    {{- end }}
type: Opaque
data: {{- include "arkcase.secret.encode" $data | nindent 2 }}
  {{- end }}
{{- end -}}
