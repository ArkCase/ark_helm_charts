---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  namespace: alfresco
  name: content
spec:
  replicas: 1
  template:
    spec:
      imagePullSecrets:
        - name: aws-arkcase-pull
      containers:
        - name: content
          image: 345280441424.dkr.ecr.ap-south-1.amazonaws.com/ark_alfresco_ee_content:7.3.1
          env:
            - name: JAVA_TOOL_OPTIONS
              value: >-
                -Dencryption.keystore.type=JCEKS
                -Dencryption.cipherAlgorithm=DESede/CBC/PKCS5Padding
                -Dencryption.keyAlgorithm=DESede
                -Dencryption.keystore.location=/usr/local/tomcat/shared/classes/alfresco/extension/keystore/keystore
                -Dmetadata-keystore.password=mp6yc0UD9e
                -Dmetadata-keystore.aliases=metadata
                -Dmetadata-keystore.metadata.password=oKIWzVdEdA
                -Dmetadata-keystore.metadata.algorithm=DESede
            - name: CATALINA_OPTS
              value: >-
                -server
                -Ddir.root=/alf_data
                -Ddb.driver=org.postgresql.Driver
                -Ddb.username=alfresco
                -Ddb.password="nie7yaiX0ahm9aec"
                -Ddb.url="jdbc:postgresql://postgres:5432/alfresco"
                -Dsolr.host=search
                -Dsolr.port=8983
                -Dsolr.secureComms=secret
                -Dsolr.sharedSecret=secret
                -Dsolr.base.url=/solr
                -Dindex.subsystem.name=solr6
                -Dshare.host=this-is-used-to-render-the-clickable-share-URL
                -Dshare.port=80
                -Dalfresco.host=localhost
                -Dalfresco.port=8080
                -Daos.baseUrlOverwrite=http://localhost:8080/alfresco/aos
                -Dmessaging.broker.url="failover:(nio://activemq:61616)?timeout=3000&jms.useCompression=true"
                -Ddeployment.method=DOCKER_COMPOSE
                -Dtransform.service.enabled=true
                -Dtransform.service.url=http://transform-router:8095
                -Dsfs.url=http://shared-file-store:8099/
                -DlocalTransform.core-aio.url=http://transform-core-aio:8090/
                -Dcsrf.filter.enabled=false
                -Ddsync.service.uris=http://localhost:9090/alfresco
                -XX:MinRAMPercentage=50
                -XX:MaxRAMPercentage=80
                -Dcom.sun.management.jmxremote
          ports:
            - containerPort: 8080
          resources:
            limits:
              memory: "2Gi"
          volumeMounts:
            - name: &contentRepository content-repository
              mountPath: "/usr/local/tomcat/alf_data"
            - name: &licenseFile license-file
              mountPath: "/usr/local/tomcat/shared/classes/alfresco/extension/license/armedia.lic"
      volumes:
        - name: *contentRepository
          hostPath:
            path: /opt/app/alfresco/data/repo
        - name: *licenseFile
          hostPath:
            path: /opt/app/alfresco/lib/armedia.lic
      restartPolicy: Always
