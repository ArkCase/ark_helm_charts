{{- if or .Values.enabled (not (hasKey .Values "enabled")) }}
apiVersion: v1
kind: Pod
metadata:
  name: '{{ include "common.fullname" . }}-test-connection'
  labels:
    {{- include "common.labels" . | nindent 4 }}
  annotations:
    'helm.sh/hook': test
spec:
  containers:
    - name: openldap
      image: bitnami/openldap
      command: [ '/opt/bitnami/openldap/bin/ldapsearch' ]
      args: [ '-H', 'ldaps://{{ template "common.fullname" . }}:{{ .Values.service.port }}', '-D', '{{ include "common.samba.realm" .Values.domain.name }}\administrator', '-w', {{ .Values.domain.password | quote }}, '-b', {{ include "common.samba.dc" .Values.domain.name | quote }}, '(objectClass=user)', 'dn' ]
      env:
        - name: LDAPTLS_REQCERT
          value: 'never'
        - name: ADMIN_PASS
          valueFrom:
            secretKeyRef:
              name: {{ template "common.fullname" . }}
              key: DOMAIN_PASSWORD
  restartPolicy: Never
{{- end }}
